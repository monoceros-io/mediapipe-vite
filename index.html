<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaPipe Image Segmenter with Pose Landmarker</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="qc qc-0">
        <video id="vid-0" class="video"></video>
        <select name="cameras-0" id="cameras-0" class="camera-select"></select>

        </select>
        <div class="video-crop-div-outer">
            <div class="video-crop-line">
                <div class="video-crop-readout">5%</div>
            </div>
            <div class="video-crop-line">
                <div class="video-crop-readout">45%</div>
            </div>
            <div class="video-crop-line">
                <div class="video-crop-readout">55%</div>
            </div>
            <div class="video-crop-line">
                <div class="video-crop-readout">95%</div>
            </div>

        </div>
    </div>
    <div class="qc qc-1">
        <canvas class="output-canvas" id="output-canvas-0"></canvas>
    </div>
    <div class="qc qc-2">
        <video id="vid-1" class="video"></video>
        <select name="cameras-1" id="cameras-1" class="camera-select"></select>

        <div class="video-crop-div-outer">
            
            <div class="video-crop-line">
                <div class="video-crop-readout">5%</div>
            </div>
            <div class="video-crop-line">
                <div class="video-crop-readout">45%</div>
            </div>
            
            <div class="video-crop-line">
                <div class="video-crop-readout">55%</div>
            </div>
            <div class="video-crop-line">
                <div class="video-crop-readout">95%</div>
            </div>
            

        </div>

    </div>
    <div class="qc qc-3">
        <canvas class="output-canvas" id="output-canvas-1"></canvas>
    </div>

    <div class="control-panel">

    </div>

    <script type="module">

        import { setupVideoUtils, matchCropToVideo } from "./camera-utils";
        

        // PAGE ELEMENTS

        const videos = document.querySelectorAll(".video");
        const cameraSelectors = document.querySelectorAll('.camera-select');
        const cropDivOuters = document.querySelectorAll(".video-crop-div-outer");


        const cdoLinePercs = [ [5, 45, 55, 95], [10, 40, 60, 90] ];

        setupVideoUtils(videos, cropDivOuters, cdoLinePercs);



        let cameraSourceActive = [false, false];
        let frameCounter = 0;

        const devices = await navigator.mediaDevices.enumerateDevices();

        devices.filter(device => device.kind === 'videoinput').forEach((device, index) => {

            for (let sel of cameraSelectors) {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.textContent = device.label || `Camera ${index + 1}`;
                sel.appendChild(option);
                sel.selectedIndex = 2;
            }
        });

        cameraSelectors.forEach((sel, index) => {
            sel.addEventListener('change', async (event) => {
                cameraSourceActive[index] = false;
                const video = document.getElementById(`vid-${index}`);
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        frameRate: { min: 30, ideal: 60 },
                        deviceId: { exact: event.target.value },
                        width: { ideal: 1920 }, // Try for 4K width
                        height: { ideal: 1080 }, // Try for 4K height
                    }
                });

                const streamStart = () => {
                    video.removeEventListener('loadeddata', streamStart);
                    cameraSourceActive[index] = true;
                    matchCropToVideo();
                }

                video.addEventListener('loadeddata', streamStart);
                video.srcObject = stream;
                video.play();

            });
        });


        window.addEventListener('resize', matchCropToVideo);



    </script>
</body>

</html>